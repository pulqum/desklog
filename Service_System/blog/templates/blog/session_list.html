{% extends 'blog/base.html' %}

{% block content %}
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    
    <!-- Active Session Card -->
    {% if active_session %}
    <div class="session-card-common active-session-card">
        <div class="status-indicator pulse"></div>
        <h2 class="card-title">ğŸ“– ê³µë¶€ ì¤‘ì…ë‹ˆë‹¤!</h2>
        <div id="study-timer" class="study-timer">00:00:00</div>
        <p class="start-time-text">ì‹œì‘ ì‹œê°„: {{ active_session.start_time|date:"H:i" }}</p>
        <div class="session-actions">
            <a href="{% url 'post_image_new' %}" class="btn btn-success btn-action">ìˆ˜ë™ ê¸°ë¡ ì¶”ê°€</a>
            <a href="{% url 'post_list' session_id=active_session.pk %}" class="btn btn-primary btn-action">ê¸°ë¡ ë³´ê¸°</a>
            <a href="{% url 'session_end' %}" class="btn btn-danger btn-action" onclick="return confirm('ê³µë¶€ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì¢…ë£Œ</a>
        </div>

        <!-- Webcam Monitoring Panel -->
        <div class="webcam-panel">
            <h4 class="webcam-title">ì‹¤ì‹œê°„ ì§‘ì¤‘ ìƒíƒœ ëª¨ë‹ˆí„°ë§</h4>
            <p class="webcam-subtitle">ì¹´ë©”ë¼ë¥¼ ì¼œë‘ë©´ ìƒíƒœê°€ ë°”ë€” ë•Œë§Œ ìë™ìœ¼ë¡œ ê¸°ë¡í•©ë‹ˆë‹¤.</p>
            <div class="webcam-layout">
                <div class="webcam-preview-wrap">
                    <video id="desklog-webcam" class="webcam-video" autoplay playsinline muted></video>
                </div>
                <div class="webcam-status-wrap">
                    <button id="desklog-webcam-toggle" class="btn btn-default btn-sm webcam-toggle-btn">
                        ì›¹ìº  ê°ì§€ ì‹œì‘
                    </button>
                    <p id="desklog-webcam-status" class="webcam-status-text">
                        ì›¹ìº ì´ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤.
                    </p>
                    <p id="desklog-webcam-last" class="webcam-last-change">
                        ë§ˆì§€ë§‰ ìƒíƒœ: ì—†ìŒ
                    </p>
                </div>
            </div>
            <small class="webcam-notice text-muted">
                * ë¸Œë¼ìš°ì € ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ì˜ìƒì€ ì„œë²„ë¡œ ì£¼ê¸°ì ìœ¼ë¡œ ìº¡ì²˜ë˜ì–´ YOLOv5ë¡œ ë¶„ì„ë©ë‹ˆë‹¤.
            </small>
        </div>
        <script>
            (function() {
                const startTimeStr = "{{ active_session.start_time|date:'c' }}";
                const timerElement = document.getElementById('study-timer');
                
                function updateTimer() {
                    const now = new Date().getTime();
                    const startTime = new Date(startTimeStr).getTime();
                    const diff = now - startTime;
                    
                    if (diff < 0) return; // Future time protection

                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    let timeString = "";
                    if (hours > 0) {
                        timeString += String(hours).padStart(2, '0') + ":";
                    }
                    timeString += String(minutes).padStart(2, '0') + ":";
                    timeString += String(seconds).padStart(2, '0');
                    
                    timerElement.textContent = timeString;
                }
                
                setInterval(updateTimer, 1000);
                updateTimer();
            })();

            // Setup webcam monitoring after DOM is ready
            document.addEventListener('DOMContentLoaded', function () {
                if (typeof setupWebcamMonitoring === 'function') {
                    setupWebcamMonitoring({{ active_session.pk }});
                }
            });
        </script>
    </div>
    {% else %}
    <div class="session-card-common start-session-card">
        <h2 class="card-title">ìƒˆë¡œìš´ ê³µë¶€ë¥¼ ì‹œì‘í•˜ì„¸ìš”</h2>
        <p class="card-subtitle">ì˜¤ëŠ˜ë„ ëª©í‘œë¥¼ í–¥í•´ ë‹¬ë ¤ë³¼ê¹Œìš”?</p>
        <a href="{% url 'session_start' %}" class="btn-start-study">
            <span class="icon">ğŸš€</span> ê³µë¶€ ì‹œì‘í•˜ê¸°
        </a>
    </div>
    {% endif %}

    <hr>

    <!-- Past Sessions List -->
    <h3>ğŸ“š ì§€ë‚œ ê³µë¶€ ê¸°ë¡</h3>
    <div class="session-list">
        {% if has_legacy_posts %}
        <div class="session-item legacy-session" onclick="location.href='{% url 'post_list' session_id=0 %}'">
            <div class="session-info">
                <span class="session-date">ğŸ“‚ ì´ì „ ê¸°ë¡ ë³´ê´€í•¨</span>
                <span class="session-time">ì„¸ì…˜ ê¸°ëŠ¥ ë„ì… ì „ ê¸°ë¡ë“¤</span>
            </div>
            <div class="session-arrow">â€º</div>
        </div>
        {% endif %}

        {% for session in sessions %}
        <div class="session-item-wrapper">
            <div class="session-item" onclick="location.href='{% url 'post_list' session_id=session.pk %}'">
                <div class="session-info">
                    <span class="session-date">{{ session.start_time|date:"Y.m.d" }}</span>
                    <span class="session-time">{{ session.start_time|date:"H:i" }} ~ {% if session.end_time %}{{ session.end_time|date:"H:i" }}{% else %}ì§„í–‰ ì¤‘{% endif %}</span>
                </div>
                <div class="session-arrow">â€º</div>
            </div>
            <form action="{% url 'session_remove' session_id=session.pk %}" method="POST" class="session-delete-form" onsubmit="return confirm('ì´ ì„¸ì…˜ê³¼ í¬í•¨ëœ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                {% csrf_token %}
                <button type="submit" class="btn-delete-session" title="ì„¸ì…˜ ì‚­ì œ">ğŸ—‘ï¸</button>
            </form>
        </div>
        {% empty %}
        {% if not has_legacy_posts %}
        <p class="no-sessions">ì•„ì§ ê¸°ë¡ëœ ê³µë¶€ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
        {% endfor %}
    </div>
</div>

<style>
    /* Common Card Style for Consistency */
    .session-card-common {
        min-height: 320px; /* Fixed height to prevent layout shift */
        border-radius: 24px;
        padding: 40px;
        text-align: center;
        margin-bottom: 40px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-shadow: 0 15px 35px rgba(0,0,0,0.08);
        position: relative;
        transition: transform 0.3s ease;
        background: #fff;
    }

    /* Active Session Specifics */
    .active-session-card {
        border: 2px solid #4caf50;
        background: linear-gradient(to bottom, #ffffff, #f1f8e9);
    }
    
    .study-timer {
        font-size: 4em;
        font-weight: 800;
        color: #2e7d32;
        font-family: 'Courier New', Courier, monospace; /* Monospace for stable numbers */
        margin: 10px 0;
        text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
    }

    .start-time-text {
        color: #666;
        margin-bottom: 20px;
        font-size: 1.1em;
    }

    .session-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        width: 100%;
    }

    .btn-action {
        padding: 10px 20px;
        border-radius: 12px;
        font-weight: 600;
    }

    /* Start Session Specifics */
    .start-session-card {
        border: 1px solid #eee;
        background: linear-gradient(to bottom, #ffffff, #fafafa);
    }

    .card-title {
        font-size: 2em;
        font-weight: 700;
        margin-bottom: 10px;
        color: #333;
    }

    .card-subtitle {
        color: #888;
        margin-bottom: 30px;
        font-size: 1.2em;
    }

    /* Stylish Start Button */
    .btn-start-study {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #4caf50 0%, #43a047 100%);
        color: white;
        padding: 18px 50px;
        font-size: 1.5em;
        font-weight: bold;
        border-radius: 50px;
        text-decoration: none;
        box-shadow: 0 10px 25px rgba(76, 175, 80, 0.4);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy effect */
        border: 2px solid transparent;
    }

    .btn-start-study:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 15px 35px rgba(76, 175, 80, 0.5);
        color: white;
        text-decoration: none;
        background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
    }

    .btn-start-study:active {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
    }

    .btn-start-study .icon {
        margin-right: 12px;
        font-size: 1.2em;
    }

    /* Pulse Indicator */
    .status-indicator {
        width: 18px;
        height: 18px;
        background-color: #4caf50;
        border-radius: 50%;
        position: absolute;
        top: 25px;
        right: 25px;
    }
    .pulse {
        animation: pulse-animation 2s infinite;
    }
    @keyframes pulse-animation {
        0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
        70% { box-shadow: 0 0 0 15px rgba(76, 175, 80, 0); }
        100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }
    .session-item-wrapper {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        gap: 10px;
    }
    .session-item {
        background: #fff;
        border: 1px solid #eee;
        padding: 20px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
        flex-grow: 1;
    }
    .session-item:hover {
        background: #f9f9f9;
    }
    .legacy-session {
        background-color: #fff8e1;
        border-color: #ffecb3;
    }
    .session-date {
        font-weight: bold;
        font-size: 1.1em;
        margin-right: 15px;
        color: #333;
    }
    .session-time {
        color: #666;
    }
    .session-arrow {
        font-size: 1.5em;
        color: #ccc;
    }
    .btn-delete-session {
        background: none;
        border: none;
        font-size: 1.2em;
        cursor: pointer;
        opacity: 0.5;
        transition: opacity 0.2s;
        padding: 10px;
    }
    .btn-delete-session:hover {
        opacity: 1;
    }

    /* Toast ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
    .toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        pointer-events: none;
    }

    .toast {
        background: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        font-size: 16px;
        font-weight: 500;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 300px;
        max-width: 500px;
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        pointer-events: auto;
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0) scale(1);
    }

    .toast-icon {
        font-size: 20px;
    }

    .toast-warning {
        background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
        border-left: 4px solid #ff9800;
        color: #856404;
    }

    .toast-success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border-left: 4px solid #4caf50;
        color: #155724;
    }

    .toast-info {
        background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        border-left: 4px solid #2196f3;
        color: #0c5460;
    }
</style>
{% endblock %}